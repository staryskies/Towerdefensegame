<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tower Defense Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; }
    body {
      overflow: hidden;
      background: #dfe6e9;
      color: #2d3436;
      position: relative;
    }
    #gameCanvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }
    #sidebar {
      position: fixed;
      top: 10px;
      left: 10px;
      width: 200px;
      background: rgba(236, 240, 241, 0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }
    .tower-option {
      padding: 8px;
      margin: 5px 0;
      background: #b2bec3;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      text-align: center;
    }
    .tower-option:hover, .tower-option.selected {
      background: #00b894;
      color: #fff;
      transform: translateY(-2px);
    }
    #party-button, #pause-button, #fast-forward-button, #home-button, #restart-party-button {
      padding: 8px;
      margin: 5px 0;
      background: linear-gradient(135deg, #00b894, #00cec9);
      border-radius: 5px;
      cursor: pointer;
      text-align: center;
      color: #fff;
      border: none;
      transition: background 0.3s ease, transform 0.2s ease;
      width: 100%;
    }
    #party-button:hover, #pause-button:hover, #fast-forward-button:hover, #home-button:hover, #restart-party-button:hover {
      background: linear-gradient(135deg, #00cec9, #0984e3);
      transform: translateY(-2px);
    }
    #pause-button.active, #fast-forward-button.active {
      background: #ff7675;
    }
    #stats {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(236, 240, 241, 0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }
    #tower-info-panel {
      position: fixed;
      bottom: 10px;
      left: 230px;
      width: 250px;
      background: rgba(236, 240, 241, 0.95);
      padding: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      display: none;
      z-index: 10;
    }
    #upgrade-power-button, #upgrade-utility-button {
      padding: 8px;
      margin: 5px 0;
      background: linear-gradient(135deg, #00b894, #00cec9);
      border-radius: 5px;
      cursor: pointer;
      width: 100%;
      color: #fff;
      border: none;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    #upgrade-power-button:hover, #upgrade-utility-button:hover {
      background: linear-gradient(135deg, #00cec9, #0984e3);
      transform: translateY(-2px);
    }
    #upgrade-power-button:disabled, #upgrade-utility-button:disabled {
      background: #b2bec3;
      cursor: not-allowed;
    }
    #notification-box {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 184, 148, 0.95);
      padding: 20px 30px;
      border-radius: 10px;
      color: white;
      display: none;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      font-weight: 500;
      max-width: 80%;
      text-align: center;
    }
    #notification-box.show {
      display: block;
    }
    #end-screen {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(236, 240, 241, 0.95);
      padding: 25px;
      border-radius: 10px;
      text-align: center;
      display: none;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      width: 90%;
      max-width: 400px;
    }
    #restart-button, #main-menu-button {
      padding: 10px 20px;
      margin: 10px;
      background: linear-gradient(135deg, #00b894, #00cec9);
      border-radius: 5px;
      cursor: pointer;
      border: none;
      color: white;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    #restart-button:hover, #main-menu-button:hover {
      background: linear-gradient(135deg, #00cec9, #0984e3);
      transform: translateY(-2px);
    }
    #chat-container {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 280px;
      background: rgba(236, 240, 241, 0.95);
      border-radius: 10px;
      padding: 15px;
      color: #2d3436;
      display: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      z-index: 10;
    }
    #chat-messages {
      height: 120px;
      overflow-y: auto;
      font-size: 12px;
      margin-bottom: 10px;
    }
    #chat-input {
      width: 100%;
      padding: 8px;
      border: 2px solid #b2bec3;
      border-radius: 5px;
      background: #dfe6e9;
      color: #2d3436;
    }
    #toggle-chat {
      position: fixed;
      bottom: 230px;
      right: 10px;
      padding: 8px 15px;
      background: linear-gradient(135deg, #00b894, #00cec9);
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s ease, transform 0.2s ease;
      z-index: 10;
    }
    #toggle-chat:hover {
      background: linear-gradient(135deg, #00cec9, #0984e3);
      transform: translateY(-2px);
    }
    #party-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(236, 240, 241, 0.95);
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
      color: #2d3436;
      z-index: 1001;
      width: 90%;
      max-width: 400px;
      display: none;
    }
    #party-modal.show {
      display: block;
    }
    #party-modal h2 {
      margin-bottom: 15px;
      font-size: 1.5rem;
    }
    #party-modal button {
      padding: 10px 20px;
      margin: 5px;
      background: linear-gradient(135deg, #00b894, #00cec9);
      border-radius: 5px;
      cursor: pointer;
      border: none;
      color: white;
      transition: background 0.3s ease, transform 0.2s ease;
    }
    #party-modal button:hover {
      background: linear-gradient(135deg, #00cec9, #0984e3);
      transform: translateY(-2px);
    }
    #party-modal input, #party-modal select {
      width: 100%;
      padding: 8px;
      margin: 5px 0;
      border: 2px solid #b2bec3;
      border-radius: 5px;
      background: #ffffff;
      color: #2d3436;
    }
    @media (max-width: 768px) {
      #sidebar, #stats, #tower-info-panel, #chat-container {
        width: 150px;
        padding: 10px;
      }
      #tower-info-panel { left: 170px; }
      #chat-messages { height: 100px; }
      #toggle-chat { bottom: 210px; }
    }
    @media (max-width: 480px) {
      #sidebar, #stats, #tower-info-panel, #chat-container {
        width: 120px;
        padding: 8px;
        font-size: 0.9rem;
      }
      #tower-info-panel { left: 140px; }
      #chat-messages { height: 80px; }
      #toggle-chat { bottom: 190px; padding: 5px 10px; }
      #party-modal, #end-screen { padding: 15px; max-width: 90%; }
    }
</style>
</head>
<body>
  <canvas id="gameCanvas" aria-label="Game Canvas"></canvas>
  <div id="sidebar" aria-label="Tower Selection and Controls">
    <!-- Towers will be populated by JS -->
    <button id="pause-button" aria-label="Pause/Resume Game" title="Pause or resume the game">Pause</button>
    <button id="speed-button" aria-label="Change Game Speed" title="Toggle game speed">Speed</button>
  </div>
  <div id="stats" aria-live="polite">
    <div id="score">Score: 0</div>
    <div id="money">Money: $0</div>
    <div id="health">Health: 20</div>
    <div id="wave">Wave: 1</div>
    <div id="speed">Speed: 1x</div>
  </div>
  <div id="tower-info-panel" aria-label="Tower Information">
    <div id="tower-type">Type: </div>
    <div id="tower-damage">Damage: </div>
    <div id="tower-range">Range: </div>
    <div id="tower-level">Level: </div>
    <div id="tower-ability">Ability: </div>
    <button id="upgrade-power-button" aria-label="Upgrade Tower Power" title="Upgrade tower power" disabled>Upgrade Power</button>
    <button id="upgrade-utility-button" aria-label="Upgrade Tower Utility" title="Upgrade tower utility" disabled>Upgrade Utility</button>
  </div>
  <div id="notification-box" aria-live="assertive"></div>
  <div id="end-screen" aria-label="Game Over Screen">
    <h2 id="end-message"></h2>
    <div id="waves-survived"></div>
    <div id="persistent-money-earned"></div>
    <div id="persistent-money-total"></div>
    <button id="restart-button" aria-label="Restart Game" title="Restart the game">Restart</button>
    <button id="main-menu-button" aria-label="Return to Main Menu" title="Return to main menu">Main Menu</button>
  </div>
  <div id="chat-container" aria-label="Chat Window">
    <div id="player-list">Players:<br></div>
    <div id="chat-messages"></div>
    <input id="chat-input" type="text" placeholder="Type a message..." aria-label="Chat Input">
  </div>
  <button id="toggle-chat" aria-label="Toggle Chat" title="Show or hide chat">Show Chat</button>
  <div id="party-modal" aria-label="Party Configuration">
    <h2>Party Settings</h2>
    <div class="form-group">
      <label for="party-map">Map</label>
      <select id="party-map" aria-label="Select Map">
        <option value="map1">Grassland</option>
        <option value="map2">Desert</option>
        <option value="map3">Stone</option>
        <option value="map4">Forest</option>
        <option value="map5">Mountain</option>
        <option value="map6">Desert</option>
        <option value="map7">River</option>
        <option value="map8">Canyon</option>
        <option value="map9">Arctic</option>
      </select>
    </div>
    <div class="form-group">
      <label for="party-difficulty">Difficulty</label>
      <select id="party-difficulty" aria-label="Select Difficulty">
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>
    </div>
    <button id="start-party-game" aria-label="Start Party Game" title="Start the game for all party members">Start Game</button>
    <button id="close-party-modal" aria-label="Close Party Settings" title="Close settings">Close</button>
  </div>

  <script src="/game.js"></script>
  <script>
    const toggleChatButton = document.getElementById("toggle-chat");
    const chatContainer = document.getElementById("chat-container");
    const partyModal = document.getElementById("party-modal");
    const startPartyGameButton = document.getElementById("start-party-game");
    const closePartyModalButton = document.getElementById("close-party-modal");
    const partyMapSelect = document.getElementById("party-map");
    const partyDifficultySelect = document.getElementById("party-difficulty");

    toggleChatButton.addEventListener("click", () => {
      if (chatContainer.style.display === "none" || chatContainer.style.display === "") {
        chatContainer.style.display = "block";
        toggleChatButton.textContent = "Hide Chat";
      } else {
        chatContainer.style.display = "none";
        toggleChatButton.textContent = "Show Chat";
      }
    });

    window.addEventListener("load", () => {
      // Ensure party settings button exists for leader in party mode
      if (localStorage.getItem("isPartyMode") === "true" && localStorage.getItem("username") === gameState.partyLeader) {
        const sidebar = document.getElementById("sidebar");
        const existingPartyButton = document.getElementById("party-button");
        if (!existingPartyButton) {
          const partyBtn = document.createElement("button");
          partyBtn.id = "party-button";
          partyBtn.textContent = "Party Settings";
          partyBtn.addEventListener("click", () => {
            if (localStorage.getItem("username") === gameState.partyLeader) {
              partyModal.classList.add("show");
            } else {
              showNotification("Only the party leader can configure settings!");
            }
          });
          sidebar.appendChild(partyBtn);
        }
      }
    });

    startPartyGameButton.addEventListener("click", () => {
      const map = partyMapSelect.value;
      const difficulty = partyDifficultySelect.value;
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: "startGame",
          partyId: gameState.partyId,
          map,
          difficulty
        }));
        partyModal.classList.remove("show");
      } else {
        showNotification("Not connected to server!");
      }
    });

    closePartyModalButton.addEventListener("click", () => {
      partyModal.classList.remove("show");
    });
  </script>
</body>
</html>