<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tower Defense Game</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="game-container">
    <canvas id="gameCanvas" width="1920" height="1080"></canvas>
    <div id="stats">
      Money: <span id="money">0</span> |
      Health: <span id="health">0</span> |
      Wave: <span id="wave">0</span> |
      Score: <span id="score">0</span>
    </div>
    <div id="controls">
      <button onclick="togglePause()">Toggle Pause</button>
      <button onclick="setSpeed(1)">1x Speed</button>
      <button onclick="setSpeed(2)">2x Speed</button>
      <label>
        Party Mode: <input type="checkbox" id="partyMode" onchange="togglePartyMode()">
      </label>
      <button onclick="placeTower('basic')">Place Basic Tower</button>
      <button onclick="upgradeTower(0, 'power')">Upgrade Tower 0 (Power)</button>
      <button onclick="upgradeTower(0, 'utility')">Upgrade Tower 0 (Utility)</button>
    </div>
  </div>

  <script src="game.js"></script>
  <script>
    const username = localStorage.getItem('username');
    let partyId = new URLSearchParams(window.location.search).get('partyId');
    let ws = null;
    let gameState = null;

    // Initialize game on page load
    (async () => {
      if (!username || !partyId) {
        alert("Please select a map and log in first!");
        window.location.href = '/map.html';
        return;
      }

      const isPartyMode = localStorage.getItem('isPartyMode') === 'true';
      document.getElementById('partyMode').checked = isPartyMode;

      const response = await fetch('/game/join', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username,
          partyId,
          difficulty: localStorage.getItem("selectedDifficulty") || "easy",
          map: localStorage.getItem("selectedMap") || "map1",
          isPartyMode,
        }),
      });
      const data = await response.json();
      partyId = data.partyId;
      gameState = {
        ...data.gameState,
        enemies: [],
        projectiles: [],
        isSpawning: false,
        spawnTimer: 0,
        enemiesToSpawn: 0,
        waveDelay: 0,
        isBossWave: false,
        bossSpawned: false,
      };
      spawnWave();
      connectWebSocket();
      startGameLoop();
    })();

    function connectWebSocket() {
      ws = new WebSocket(`ws://${window.location.host}/?partyId=${partyId}&username=${username}`);
      ws.onopen = () => console.log('WebSocket connected');
      ws.onmessage = (event) => {
        const update = JSON.parse(event.data);
        handleServerUpdate(update);
      };
      ws.onclose = () => {
        console.log('WebSocket disconnected. Reconnecting...');
        setTimeout(connectWebSocket, 1000);
      };
      ws.onerror = (error) => console.error('WebSocket error:', error);
    }

    function handleServerUpdate(update) {
      switch (update.type) {
        case 'INITIAL_STATE':
          gameState = { ...gameState, ...update.gameState };
          break;
        case 'UPDATE_STATE':
          if ('isPaused' in update) gameState.isPaused = update.isPaused;
          if ('gameSpeed' in update) gameState.gameSpeed = update.gameSpeed;
          if ('gameMoney' in update) gameState.gameMoney = update.gameMoney;
          if ('playerHealth' in update) gameState.playerHealth = update.playerHealth;
          if ('score' in update) gameState.score = update.score;
          if ('wave' in update) gameState.wave = update.wave;
          if ('gameOver' in update) gameState.gameOver = update.gameOver;
          if ('gameWon' in update) gameState.gameWon = update.gameWon;
          if ('enemies' in update) gameState.enemies = update.enemies;
          if ('towers' in update) gameState.towers = update.towers;
          if ('projectiles' in update) gameState.projectiles = update.projectiles;
          break;
        case 'TOWER_PLACED':
          gameState.towers[update.index] = update.tower;
          break;
        case 'TOWER_UPGRADED':
          gameState.towers[update.towerIndex] = update.tower;
          break;
      }
      updateStatsUI();
    }

    function sendAction(action) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify(action));
      }
    }

    function togglePause() {
      sendAction({ type: 'TOGGLE_PAUSE' });
    }

    function setSpeed(speed) {
      sendAction({ type: 'SET_SPEED', speed });
    }

    function togglePartyMode() {
      const isPartyMode = document.getElementById('partyMode').checked;
      localStorage.setItem('isPartyMode', isPartyMode);
      // Rejoin game with updated mode if needed
      window.location.reload();
    }

    function placeTower(type) {
      const x = Math.random() * canvas.width;
      const y = Math.random() * canvas.height;
      sendAction({ type: 'PLACE_TOWER', towerType: type, x, y });
    }

    function upgradeTower(towerIndex, path) {
      sendAction({ type: 'UPGRADE_TOWER', towerIndex, path });
    }
  </script>
</body>
</html>